# Create Tables

## dim_accounts

CREATE TABLE dim_accounts (
    -- Surrogate key
    account_id BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 10000001) PRIMARY KEY,

    -- Business / natural key (from CSV)
    account TEXT NOT NULL UNIQUE,

    -- Other columns
    sector TEXT,
    year_established INTEGER,
    revenue NUMERIC(18,2),
    employees INTEGER,
    office_location TEXT,
    subsidiary_of TEXT
);

\copy dim_accounts(account, sector, year_established, revenue, employees, office_location, subsidiary_of)
FROM 'C:\Users\Gio Noga\Documents\Data Analysis 101\repos\gn-data-crm_pricing_analysis\clean_dataset\01_accounts_cleaned.csv'
DELIMITER ','
CSV HEADER;


## dim_products

CREATE TABLE dim_products (
    -- Surrogate key
    product_id BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 20000001) PRIMARY KEY,

    -- Business / natural key
    product TEXT NOT NULL UNIQUE,

    -- Other columns
    series TEXT,
    sales_price NUMERIC(18,2)
);

# dim_sales_teams

CREATE TABLE dim_sales_teams (
    -- Surrogate key
    agent_id BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 30000001) PRIMARY KEY,

    -- Business / natural key
    sales_agent TEXT NOT NULL UNIQUE,

    -- Other columns
    manager TEXT,
    regional_office TEXT
);

# raw_sales_pipeline

opportunity_id,sales_agent,product,account,deal_stage,engage_date,close_date,close_value

CREATE TABLE raw_sales_pipeline (
    opportunity_id TEXT,
    sales_agent TEXT,
    product TEXT,
    account TEXT,
    deal_stage TEXT,
    engage_date DATE,
    close_date DATE,
    close_value NUMERIC(18,2)
)

# fact_sales_pipeline

CREATE TABLE stg_sales_pipeline (
    opportunity_id TEXT,
    sales_agent TEXT,
    product TEXT,
    account TEXT,
    deal_outcome TEXT,
    engage_date DATE,
    close_date DATE,
    deal_duration INTEGER,
    deal_duration_bucket_month TEXT,
    close_value NUMERIC(18,2),
    price_adjustment_pct NUMERIC(6,5)
);


CREATE TABLE fact_sales_pipeline (
    opportunity_id TEXT PRIMARY KEY,

    -- Foreign keys to dimension tables
    agent_id BIGINT NOT NULL REFERENCES dim_sales_teams(agent_id),
    product_id BIGINT NOT NULL REFERENCES dim_products(product_id),
    account_id BIGINT NOT NULL REFERENCES dim_accounts(id),

    -- Fact attributes
    deal_outcome TEXT,
    engage_date DATE,
    close_date DATE,
    deal_duration INTEGER,
    deal_duration_bucket_month TEXT,
    close_value NUMERIC(18,2),
    price_adjustment_pct NUMERIC(6,5)
);


INSERT INTO fact_sales_pipeline (
    opportunity_id,
    agent_id,
    product_id,
    account_id,
    deal_outcome,
    engage_date,
    close_date,
    deal_duration,
    deal_duration_bucket_month,
    close_value,
    price_adjustment_pct
)
SELECT
    s.opportunity_id,
    a.agent_id,
    p.product_id,
    ac.account_id,
    s.deal_outcome,
    s.engage_date,
    s.close_date,
    s.deal_duration,
    s.deal_duration_bucket_month,
    s.close_value,
    s.price_adjustment_pct
FROM stg_sales_pipeline s
JOIN dim_sales_teams a ON s.sales_agent = a.sales_agent
JOIN dim_products p ON s.product = p.product
JOIN dim_accounts ac ON s.account = ac.account;

# Referential Integrity (These validate relationships between fact and dimension tables.)

## Orphan FK Validation (Ensure every foreign key in the fact table exists in its dimension.No fact row references a non-existent dimension row)

SELECT COUNT(*) AS orphan_agent_rows
FROM fact_sales_pipeline fct
LEFT JOIN dim_sales_teams dim 
	ON fct.agent_id = dim.agent_id
WHERE dim.agent_id IS NULL;

SELECT COUNT(*) AS orphan_account_rows
FROM fact_sales_pipeline fct
LEFT JOIN dim_accounts dim
	ON fct.account_id = dim.account_id
WHERE dim.account_id IS NULL;

SELECT COUNT(*) AS orphan_product_rows
FROM fact_sales_pipeline fct
LEFT JOIN dim_products dim
	ON fct.product_id = dim.product_id
WHERE dim.product_id IS NULL;

## Dimension Coverage Validation (Validate whether dimension members without fact coverage are explainable and non-impacting)

# Sales Team

Objective:
Validate whether all dimension members have corresponding fact records or are explainably unused within the reporting period.

Validation Query
SELECT COUNT(*) AS unref_dim_agent
FROM dim_sales_teams dim
LEFT JOIN fact_sales_pipeline fct
  ON fct.agent_id = dim.agent_id
WHERE fct.agent_id IS NULL;

Result

Five (5) agents were identified with no corresponding records in the cleaned fact table (closed deals only):

Carol Thompson

Mei-Mei Johns

Natalya Ivanova

Carl Lin

Elizabeth Anderson

Pattern Analysis

A review of region and manager attributes was conducted for the identified agents:

Agent	Manager	Region
Carol Thompson	Celia Rouche	West
Mei-Mei Johns	Melvin Marxen	Central
Natalya Ivanova	Rocco Neubert	East
Carl Lin	Summer Sewald	West
Elizabeth Anderson	Cara Losch	East

Finding:
No shared region, manager, or organizational pattern was identified.

Raw Data Validation

To determine whether these agents were excluded due to business logic (closed deals only), the raw dataset containing all deal statuses was evaluated:

SELECT dim.*
FROM raw_sales_pipeline raw
RIGHT JOIN dim_sales_teams dim
  ON raw.sales_agent = dim.sales_agent
WHERE raw.sales_agent IS NULL;


Result:
The same five agents were not present in the raw dataset, indicating no participation in either closed or ongoing deals during the reporting period.

Interpretation

These agents did not engage in any recorded sales activity within the dataset timeframe.

There is no evidence of data loss, ETL filtering issues, or join key mismatches.

Agent hire date data is unavailable, preventing tenure-based conclusions.

Conclusion

The absence of these five agents in both cleaned and raw datasets is explainable and non-impacting.
They are classified as inactive dimension members for the reporting period, not orphaned or erroneous records.

Additionally, all agent_id values present in the cleaned fact table were confirmed to have valid corresponding records in the dimension table, ensuring referential integrity.

Overall impact:
No effect on analytical accuracy or model validity. 

## Product

SELECT COUNT(*) AS unref_product_count
FROM dim_products dim
LEFT JOIN fact_sales_pipeline fct
	ON dim.product_id = fct.product_id
WHERE fct.product_id IS NULL;

## Accounts

SELECT COUNT(*) AS unref_account_count
FROM dim_accounts dim
LEFT JOIN fact_sales_pipeline fct
	ON dim.account_id = fct.account_id
WHERE fct.account_id IS NULL;

“Referential integrity has been validated, unused dimensions have been investigated and explained, and no data handling issues were identified. Analysis can proceed under the documented business constraints.”